<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chess Puzzle Master</title>
    <link rel="icon" type="image/png" href="assets/logo.png">

    <script src="js/jQuery-v3_4_1_online.js" > </script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyBF79HwGGUBYzqDJ5KIAjcAVkavh5HANu8",
          authDomain: "roynek-9fa24.firebaseapp.com",
          projectId: "roynek-9fa24",
          messagingSenderId: "834454183064",
          appId: "1:834454183064:web:b47049523154d26cfc44ed"
        };
      
        // 1Ô∏è‚É£ Init Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
      
        // 2Ô∏è‚É£ Register Service Worker
        if ('serviceWorker' in navigator) {
          await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        }
      
        // 3Ô∏è‚É£ Ask permission + get token
        async function initPush() {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') return;
      
          const token = await getToken(messaging, {
            vapidKey: "BFRRcDPbYEr2HORtn49Gz_K6WNKBFoRyOkLh_DD2XwhzdIGzV3e6b3yjN5dgQ9fIuZ3JWvmP0pDsAduH9T0mamw"
          });
      
          if (token) {
            console.log("FCM Token:", token);
      
            // send token to backend
            fetch("/alltrenders/codes/backend/update_user_token.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token,
                key: "gjhtiidsimi09403jfjkdknf7584K"
              })
            });
          }
        }
      
        // 4Ô∏è‚É£ Listen for messages while page is open
        onMessage(messaging, payload => {
          console.log("Foreground notification:", payload);
        });
      
        initPush();
      </script>


    <!-- <script src="https://www.gstatic.com/firebasejs/3.7.2/firebase.js"></script>
    <script>
        function sendTokenToServer(currentToken) {
            //alert(currentToken);
            // console.log(currentToken);
            $.post("https://roynek.com/alltrenders/codes/backend/update_user_token.php", {
                token: currentToken,
                key: "gjhtiidsimi09403jfjkdknf7584K"
            },
                function(data, status){
                    //alert("sent overhere: "+ data);
                });
            
        
        }        

        function firebase_powerhouse(){

            var config = {
                apiKey: "AIzaSyBF79HwGGUBYzqDJ5KIAjcAVkavh5HANu8",
                authDomain: "roynek-9fa24.firebaseapp.com",
                projectId: "roynek-9fa24",
                storageBucket: "roynek-9fa24.appspot.com",
                messagingSenderId: "834454183064",
                appId: "1:834454183064:web:b47049523154d26cfc44ed",
                measurementId: "G-MEKYR6V6PR"
            };
            
            firebase.initializeApp(config);
            
            const messaging = firebase.messaging();
            
            messaging.requestPermission()
            .then(function() {
                console.log('Notification permission granted.');
                return messaging.getToken();
            })
            .then(function(token) {
                console.log(token); // Display user token
                sendTokenToServer(token);
                //alert(token);
            
            })
            .catch(function(err) { // Happen if user deney permission
                console.log('Unable to get permission to notify.', err);
            //alert(err);
            });
            
            // Callback fired if Instance ID token is updated.
            messaging.onTokenRefresh(() => {
            messaging.getToken().then((refreshedToken) => {
                console.log('Token refreshed.');
                // Indicate that the new Instance ID token has not yet been sent to the
                // app server.
                //setTokenSentToServer(false);
                // Send Instance ID token to app server.
                sendTokenToServer(refreshedToken);
                // ...
            }).catch((err) => {
                console.log('Unable to retrieve refreshed token ', err);
            });
            });
            
            messaging.onMessage(function(payload){
                console.log('onMessage',payload);
            })
        }
        
        
        document.addEventListener('DOMContentLoaded', function () {
            firebase_powerhouse();
        });
        
    </script> -->

    <!-- <script src="https://www.gstatic.com/firebasejs/3.7.2/firebase.js"></script>
    <script>
        function sendTokenToServer(currentToken) {
            //alert(currentToken);
            let domain = "https://roynek.com/alltrenders/codes/";
            
            $.post(domain+"backend/update_user_token.php", {
                token: currentToken,
                key: "gjhtiidsimi09403jfjkdknf7584K"
            },
                function(data, status){
                    //alert("sent overhere: "+ data);
                });
            
        
        }
    </script>
    <script>

        
        var config = {
            apiKey: "AIzaSyBF79HwGGUBYzqDJ5KIAjcAVkavh5HANu8",
            authDomain: "roynek-9fa24.firebaseapp.com",
            projectId: "roynek-9fa24",
            storageBucket: "roynek-9fa24.appspot.com",
            messagingSenderId: "834454183064",
            appId: "1:834454183064:web:b47049523154d26cfc44ed",
            measurementId: "G-MEKYR6V6PR"
        };
        firebase.initializeApp(config);
        
        const messaging = firebase.messaging();
        
        messaging.requestPermission()
        .then(function() {
          console.log('Notification permission granted.');
          return messaging.getToken();
        })
        .then(function(token) {
          console.log(token); // Display user token
          sendTokenToServer(token);
          //alert(token);
        
        })
        .catch(function(err) { // Happen if user deney permission
          console.log('Unable to get permission to notify.', err);
          //alert(err);
        });
        
        // Callback fired if Instance ID token is updated.
        messaging.onTokenRefresh(() => {
          messaging.getToken().then((refreshedToken) => {
            console.log('Token refreshed.');
            // Indicate that the new Instance ID token has not yet been sent to the
            // app server.
            //setTokenSentToServer(false);
            // Send Instance ID token to app server.
            sendTokenToServer(refreshedToken);
            // ...
          }).catch((err) => {
            console.log('Unable to retrieve refreshed token ', err);
          });
        });
        
        messaging.onMessage(function(payload){
            console.log('onMessage',payload);
        })
        
        
        
        function OpenMainPost(postId){
            //var thepost = target.getAttribute("class");
            var currentPage = window.location.href;
            var get_all_data = currentPage.indexOf("?");
            var only_data_side = (get_all_data >= 0) ? currentPage.slice(0, get_all_data) : currentPage;
            //console.log(get_all_data, only_data_side);
            var url = only_data_side + "?post_id=" + postId;
            location.assign(url);
        }
        
    </script> -->
        
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #10b981; --primary-dark: #059669; --secondary: #6366f1;
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --border: #334155;
            --success: #10b981; --error: #ef4444; --warning: #f59e0b;
            --light-square: #f0d9b5; --dark-square: #b58863;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark); color: var(--text-primary);
            min-height: 100vh; overflow-x: hidden;
        }
        .header {
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            padding: 1rem; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem; font-weight: 700; }
        .menu-btn {
            background: none; border: none; color: var(--text-primary);
            font-size: 1.5rem; cursor: pointer; padding: 0.5rem;
            border-radius: 0.5rem; transition: background 0.2s;
        }
        .menu-btn:hover { background: var(--bg-hover); }
        .sidebar {
            position: fixed; top: 0; right: -300px; width: 300px; height: 100vh;
            background: var(--bg-card); border-left: 1px solid var(--border);
            transition: right 0.3s ease; z-index: 200; overflow-y: auto; padding: 1rem;
        }
        .sidebar.open { right: 0; }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 150; opacity: 0;
            pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: all; }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem;
        }
        .close-btn {
            background: none; border: none; color: var(--text-primary);
            font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem;
        }
        .sidebar-section { margin-bottom: 1.5rem; }
        .sidebar-section h3 {
            font-size: 0.875rem; text-transform: uppercase;
            color: var(--text-secondary); margin-bottom: 0.75rem;
        }
        .stat-item {
            display: flex; justify-content: space-between; padding: 0.75rem;
            background: var(--bg-dark); border-radius: 0.5rem; margin-bottom: 0.5rem;
        }
        .stat-label { color: var(--text-secondary); }
        .stat-value { font-weight: 600; color: var(--primary); }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .game-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .status-bar {
            background: var(--bg-card); border-radius: 1rem; padding: 1rem;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem;
        }
        .status-item { display: flex; align-items: center; gap: 0.5rem; }
        .status-icon { font-size: 1.25rem; }
        .status-text { display: flex; flex-direction: column; }
        .status-label { font-size: 0.75rem; color: var(--text-secondary); }
        .status-value { font-weight: 600; font-size: 1rem; }
        .turn-indicator {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 1rem; padding: 1rem; text-align: center; margin-bottom: 1rem;
        }
        .turn-text { font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .progress-bar {
            background: rgba(255,255,255,0.2); height: 6px;
            border-radius: 3px; overflow: hidden;
        }
        .progress-fill { height: 100%; background: white; transition: width 0.3s ease; }
        .board-wrapper {
            background: var(--bg-card); border-radius: 1rem; padding: 1rem;
            display: flex; flex-direction: column; align-items: center;
        }
        /* #chessboard {
            width: min(calc(100vw - 2rem), 560px);
            _height: min(calc(100vw - 2rem), 560px); 
            border: 2px solid var(--border); 
            border-radius: 0.5rem; 
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: grid; grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
        } */

        #chessboard {
            width: min(calc(100vw - 2rem), 560px);
            /* Automatically sets height equal to width : Aspect Ratio*/
            /* aspect-ratio: 1 / 1;  */

            border: 2px solid var(--border); 
            border-radius: 0.5rem; 
            overflow: hidden; /* Change auto to hidden since it's now a square */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: grid; 
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
        }
        .square {
            position: relative; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-size: clamp(2.5rem, 6vw, 4rem); transition: all 0.15s;
        }
        .square.light { background-color: var(--light-square); }
        .square.dark { background-color: var(--dark-square); }
        .square.selected {
            background-color: #baca44 !important;
            box-shadow: inset 0 0 0 3px #9dad2d;
        }
        .square.highlight { background-color: rgba(186, 202, 68, 0.5) !important; }
        .square.last-move { background-color: rgba(255, 255, 0, 0.4) !important; }
        .square.correct-move { animation: correctPulse 0.6s ease; }
        .square.wrong-move { animation: wrongShake 0.5s ease; }
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); background-color: rgba(16, 185, 129, 0.6); }
            50% { transform: scale(1.05); background-color: rgba(16, 185, 129, 0.9); }
        }
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); background-color: rgba(239, 68, 68, 0.6); }
            25% { transform: translateX(-5px); background-color: rgba(239, 68, 68, 0.8); }
            75% { transform: translateX(5px); background-color: rgba(239, 68, 68, 0.8); }
        }
        .square:active { transform: scale(0.95); }
        .piece {
            user-select: none; pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            font-size: 1em;
        }
        .piece.white { color: #ffffff; text-shadow: 0 0 2px #000, 0 0 3px #000, 1px 1px 2px rgba(0,0,0,0.8); }
        .piece.black { color: #000000; text-shadow: 0 0 2px #fff, 0 0 3px #fff, 1px 1px 2px rgba(255,255,255,0.5); }
        .controls {
            display: flex; gap: 0.75rem; margin-top: 1rem;
            flex-wrap: wrap; justify-content: center; width: 100%;
        }
        .btn {
            padding: 0.875rem 1.5rem; border: none; border-radius: 0.75rem;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 0.5rem;
            flex: 1; justify-content: center; min-width: 120px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-primary); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-icon {
            background: var(--bg-hover); width: 48px; height: 48px;
            border-radius: 0.75rem; display: flex; align-items: center;
            justify-content: center; padding: 0; flex: 0; min-width: auto;
        }
        .feedback {
            margin-top: 1rem; padding: 1rem; border-radius: 0.75rem;
            text-align: center; font-weight: 600; animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .feedback.success {
            background: rgba(16, 185, 129, 0.2); color: var(--success);
            border: 2px solid var(--success);
        }
        .feedback.error {
            background: rgba(239, 68, 68, 0.2); color: var(--error);
            border: 2px solid var(--error);
        }
        .feedback.info {
            background: rgba(99, 102, 241, 0.2); color: var(--secondary);
            border: 2px solid var(--secondary);
        }
        .hidden { display: none !important; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; align-items: center;
            justify-content: center; z-index: 1000; padding: 1rem;
        }
        .modal-content {
            background: var(--bg-card); padding: 2rem; border-radius: 1.5rem;
            text-align: center; max-width: 500px; width: 100%;
            animation: modalSlide 0.3s;
        }
        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content h2 { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); }
        .modal-content p { font-size: 1.1rem; margin-bottom: 1.5rem; color: var(--text-secondary); }
        .modal-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .modal-actions .btn { flex: 1; }
        .ad-modal {
            background: var(--bg-dark); padding: 2rem; border-radius: 1.5rem;
            max-width: 600px; width: 100%;
        }
        .ad-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 1.5rem;
        }
        .ad-title { font-size: 1.5rem; font-weight: 700; }
        .ad-content {
            background: var(--bg-card); padding: 1rem; border-radius: 1rem;
            margin-bottom: 1.5rem; min-height: 250px;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center;
        }
        .skip-timer {
            background: var(--bg-hover); padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; text-align: center;
            margin-bottom: 1rem; font-weight: 600;
        }
        @media (min-width: 768px) {
            .game-layout { grid-template-columns: 1fr; }
            #chessboard { width: 560px; height: 560px; }
        }
        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .logo { font-size: 1rem; }
            .container { padding: 0.5rem; }
            .status-bar { padding: 0.75rem; gap: 0.5rem; }
            .status-item { font-size: 0.875rem; }
            .turn-indicator { padding: 0.75rem; margin-bottom: 0.5rem; }
            .turn-text { font-size: 0.95rem; }
            .board-wrapper { padding: 0.5rem; }
            .controls { gap: 0.5rem; }
            .btn { padding: 0.75rem 1rem; font-size: 0.9rem; min-width: 100px; }
            .modal-content, .ad-modal { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <audio id="moveSound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhADU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4S4EQ7HAAAAAAAA//sQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+xBkAA/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=" type="audio/mpeg">
    </audio>
    <audio id="successSound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhADU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4S4EQ7HAAAAAAAA" type="audio/mpeg">
    </audio>
    <div class="header">
        <div class="logo"><span>‚ôüÔ∏è</span><span>Chess Puzzle Master</span></div>
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üìä Stats</h2>
            <button class="close-btn" id="closeSidebar">‚úï</button>
        </div>
        <div class="sidebar-section">
            <h3>Current Puzzle</h3>
            <div class="stat-item">
                <span class="stat-label">Rating</span>
                <span class="stat-value" id="sidebarRating">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Themes</span>
                <span class="stat-value" id="sidebarThemes">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Progress</span>
                <span class="stat-value" id="sidebarProgress">-</span>
            </div>
        </div>
        <div class="sidebar-section">
            <h3>Actions</h3>
            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" id="sidebarShare">üîó Share Puzzle</button>
            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" id="sidebarRemoveAds">üö´ Remove Ads - $10</button>
        </div>
    </div>
    <div class="container">
        <div class="game-layout">
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-icon">‚≠ê</span>
                    <div class="status-text">
                        <span class="status-label">Rating</span>
                        <span class="status-value" id="rating">-</span>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">üéØ</span>
                    <div class="status-text">
                        <span class="status-label">Themes</span>
                        <span class="status-value" id="themes">-</span>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">üìà</span>
                    <div class="status-text">
                        <span class="status-label">Progress</span>
                        <span class="status-value" id="progress">0/0</span>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">‚è±Ô∏è</span>
                    <div class="status-text">
                        <span class="status-label">Time</span>
                        <span class="status-value" id="timer">2:00</span>
                    </div>
                </div>
            </div>
            <div class="turn-indicator">
                <div class="turn-text" id="turnIndicator">Loading puzzle...</div>
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="board-wrapper">
                <div id="chessboard"></div>
                <div class="controls">
                    <button id="newPuzzle" class="btn btn-primary">‚ñ∂Ô∏è Next</button>
                    <button id="hint" class="btn btn-icon">üí°</button>
                    <button id="reset" class="btn btn-icon">üîÑ</button>
                    <button id="share" class="btn btn-icon">üîó</button>
                </div>
                <div id="feedback" class="feedback hidden"></div>
            </div>
        </div>
    </div>
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <div class="modal-actions" id="modalActions">
                <button id="modalClose" class="btn btn-primary">Continue</button>
            </div>

            <!-- the modal ads -->
            <div id="puzzle-ad-wrapper" style="display:none; margin-top:16px;">
                <div id="container-42aaec9dd1de27b297373dbccfd79422"></div>
            </div>
              
        </div>
    </div>
    <div id="adModal" class="modal hidden">
        <div class="ad-modal">
            <div class="ad-header"><div class="ad-title">üì∫ Advertisement</div></div>
            <div class="ad-content" id="adContent"></div>
            <div class="skip-timer" id="skipTimer">Please wait <span id="skipCountdown">3</span> seconds...</div>
            <button id="skipAd" class="btn btn-primary" style="width: 100%;" disabled>Skip Ad</button>
        </div>
    </div>
    <!-- <script type="text/javascript" src="https://pl22148621.effectivegatecpm.com/68/4a/2c/684a2c10b94efdb9b3e48639123b1358.js"></script> -->
    
    <script>
        class ChessGame {
            constructor() { this.board = []; this.currentFEN = ''; this.isWhiteTurn = true; }
            parseFEN(fen) {
                this.board = Array(8).fill(null).map(() => Array(8).fill(null));
                const parts = fen.split(' '), position = parts[0], rows = position.split('/');
                for (let i = 0; i < 8; i++) {
                    let col = 0;
                    for (let char of rows[i]) {
                        if (char >= '1' && char <= '8') col += parseInt(char);
                        else { this.board[i][col] = char; col++; }
                    }
                }
                this.isWhiteTurn = parts[1] === 'w'; this.currentFEN = fen;
            }
            getPiece(row, col) { if (row < 0 || row > 7 || col < 0 || col > 7) return null; return this.board[row][col]; }
            setPiece(row, col, piece) { if (row >= 0 && row <= 7 && col >= 0 && col <= 7) this.board[row][col] = piece; }
            isWhitePiece(piece) { return piece && piece === piece.toUpperCase(); }
            algebraicToCoords(algebraic) { return { row: 8 - parseInt(algebraic[1]), col: algebraic.charCodeAt(0) - 97 }; }
            coordsToAlgebraic(row, col) { return String.fromCharCode(97 + col) + (8 - row).toString(); }
            makeMove(from, to) {
                const fromCoords = this.algebraicToCoords(from), toCoords = this.algebraicToCoords(to);
                const piece = this.getPiece(fromCoords.row, fromCoords.col);
                if (!piece) return false;
                let movingPiece = piece;
                if (to.length > 2) { movingPiece = to[2]; if (this.isWhitePiece(piece)) movingPiece = movingPiece.toUpperCase(); }
                this.setPiece(toCoords.row, toCoords.col, movingPiece);
                this.setPiece(fromCoords.row, fromCoords.col, null);
                this.isWhiteTurn = !this.isWhiteTurn;
                return true;
            }
            getPieceUnicode(piece) {
                const pieces = { 'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô', 'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü' };
                return pieces[piece] || '';
            }
            getPossibleMoves(row, col) {
                const moves = [], piece = this.getPiece(row, col);
                if (!piece) return moves;
                const isWhite = this.isWhitePiece(piece);
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const target = this.getPiece(r, c);
                        if (!target || this.isWhitePiece(target) !== isWhite) moves.push({ row: r, col: c });
                    }
                }
                return moves;
            }
        }

        const game = new ChessGame();
        let currentPuzzle = null, currentMoveIndex = 0, playerMoveIndex = 0, selectedSquare = null;
        let timer = null, timeLeft = 120, lastMoveSquares = [];
        const isLocalhost =
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1';

        const time2nextPuzzle = 5000; //3000;

        const BASE_URL = isLocalhost
            ? 'http://localhost:3000/Chess_Sol_Puzzles'   // üëà change to your local API port
            : 'https://roynek.com/Chess_Sol_Puzzles';

        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            if (sound) { sound.currentTime = 0; sound.play().catch(() => {}); }
        }

        function getPuzzleCount() { return parseInt(localStorage.getItem('puzzleCount') || '0'); }
        function incrementPuzzleCount() {
            const count = getPuzzleCount() + 1;
            conunt = (count > 2) ? 0 : count;
            localStorage.setItem('puzzleCount', count.toString());
            return count;
        }
        function hasAdFreeAccess() { return localStorage.getItem('gaToken') === 'active'; }
        function shouldShowAd() {
            if (hasAdFreeAccess()) return false;
            const count = getPuzzleCount();
            console.log("the count is: ", count);
            // if (count > 2){incrementPuzzleCount(100);}
            return count > 0 && count % 2 === 0;
        }


        function loadAdScript_adsterra() {
            if (document.getElementById('adScript')) return;

            const script = document.createElement('script');
            script.id = 'adScript';
            script.src = 'https://pl22148621.effectivegatecpm.com/68/4a/2c/684a2c10b94efdb9b3e48639123b1358.js';
            script.async = true;

            document.getElementById('adContent').appendChild(script);
        }


        // function loadNativeAd_adsterra() {
        //     const adContent = document.getElementById('adContent');
        //     if (!adContent) return;

        //     // Prevent loading twice
        //     if (document.getElementById('adsterra-native-script')) return;

        //     // Create container
        //     const container = document.createElement('div');
        //     container.id = 'container-42aaec9dd1de27b297373dbccfd79422';
        //     adContent.appendChild(container);

        //     // Create script
        //     const script = document.createElement('script');
        //     script.id = 'adsterra-native-script';
        //     script.async = true;
        //     script.setAttribute('data-cfasync', 'false');
        //     script.src =
        //         'https://pl22148429.effectivegatecpm.com/42aaec9dd1de27b297373dbccfd79422/invoke.js';

        //     adContent.appendChild(script);
        // }

        function loadNativeAd_adsterra(forceReload = false) {
            const adContent = document.getElementById('adContent');
            if (!adContent) return;

            if (forceReload) {
                adContent.innerHTML = '';
            } else {
                // Prevent accidental double-load
                if (document.getElementById('adsterra-native-script')) return;
            }

            // Create container
            if(document.getElementById('container-42aaec9dd1de27b297373dbccfd79422')){
                const adContainer = document.getElementById('container-42aaec9dd1de27b297373dbccfd79422');
                modal.appendChild(adContainer); // moves it in the DOM, keeps ID same
            }else{
                const container = document.createElement('div');
                container.id = 'container-42aaec9dd1de27b297373dbccfd79422';
                adContent.appendChild(container);
            }

            // Create script
            const script = document.createElement('script');
            script.id = 'adsterra-native-script';
            script.async = true;
            script.setAttribute('data-cfasync', 'false');
            script.src =
                'https://pl22148429.effectivegatecpm.com/42aaec9dd1de27b297373dbccfd79422/invoke.js';

            adContent.appendChild(script);
        }


        // let adsterraLoaded = false;
        // function loadPuzzleSolvedAd() {
        //     const adWrapper = document.getElementById('puzzle-ad-wrapper');
        //     if (!adWrapper) return;

        //     adWrapper.style.display = 'block';

        //     // Prevent loading script multiple times
        //     if (adsterraLoaded) return;

        //     const script = document.createElement('script');
        //     script.async = true;
        //     script.setAttribute('data-cfasync', 'false');
        //     script.src =
        //     'https://pl22148429.effectivegatecpm.com/42aaec9dd1de27b297373dbccfd79422/invoke.js';

        //     document.body.appendChild(script);
        //     adsterraLoaded = true;
        // }
        
        // This Ads would only show when a puzzle is successfully solved...
        let puzzlesSolvedSinceAd = 0;
        function loadPuzzleSolvedAd_adsterra() {
            const adWrapper = document.getElementById('puzzle-ad-wrapper');
            if (!adWrapper) return;

            puzzlesSolvedSinceAd++;

            // Show ad every 2 puzzles
            if (puzzlesSolvedSinceAd < 2) return;

            puzzlesSolvedSinceAd = 0;

            adWrapper.style.display = 'block';

            const container = document.getElementById(
                'container-42aaec9dd1de27b297373dbccfd79422'
            );

            // Clear old ad
            // container.innerHTML = '';

            // Remove previous script if any
            const oldScript = document.getElementById('adsterra-native');
            if (oldScript) oldScript.remove();

            // Load fresh ad
            const script = document.createElement('script');
            script.id = 'adsterra-native';
            script.async = true;
            script.setAttribute('data-cfasync', 'false');
            script.src =
            'https://pl22148429.effectivegatecpm.com/42aaec9dd1de27b297373dbccfd79422/invoke.js';

            document.body.appendChild(script);
        }


        let adCountdownInterval = null;

        function showAdModal() {
            const modal = document.getElementById('adModal');
            const skipBtn = document.getElementById('skipAd');
            const countdown = document.getElementById('skipCountdown');
            const adContent = document.getElementById('adContent');

            if (!modal || !skipBtn || !countdown || !adContent) return;

            let seconds = 5;

            adContent.innerHTML = '<div id="socialbarContainer"></div>';
            // loadAdScript_adsterra();
            loadNativeAd_adsterra(true);

            modal.classList.remove('hidden');
            skipBtn.disabled = true;
            countdown.textContent = seconds;

            clearInterval(adCountdownInterval);

            adCountdownInterval = setInterval(() => {
                seconds--;

                if (!countdown) return;

                countdown.textContent = seconds;

                if (seconds <= 0) {
                    clearInterval(adCountdownInterval);
                    skipBtn.disabled = false;

                    const timerText = document.getElementById('skipTimer');
                    if (timerText) {
                        timerText.textContent = 'You can now skip';
                    }
                }
            }, 1000);
        }

        function closeAdModal() {
            clearInterval(adCountdownInterval);

            const modal = document.getElementById('adModal');
            const timer = document.getElementById('skipTimer');
            const countdown = document.getElementById('skipCountdown');

            if (modal) modal.classList.add('hidden');
            if (timer) timer.innerHTML = 'Please wait <span id="skipCountdown">5</span> seconds...';
        }



        // function showAdModal() {
        //     const modal = document.getElementById('adModal');
        //     const skipBtn = document.getElementById('skipAd');
        //     const countdown = document.getElementById('skipCountdown');
        //     const adContent = document.getElementById('adContent');
        //     let seconds = 3;

        //     adContent.innerHTML = '<div id="socialbarContainer"></div>';
            
        //     modal.classList.remove('hidden');
        //     skipBtn.disabled = true;

        //     const countdownInterval = setInterval(() => {
        //         seconds--;
        //         countdown.textContent = seconds;
        //         if (seconds <= 0) {
        //             clearInterval(countdownInterval);
        //             skipBtn.disabled = false;
        //             document.getElementById('skipTimer').textContent = 'You can now skip';
        //         }
        //     }, 1000);
        // }

        // function closeAdModal() {
        //     document.getElementById('adModal').classList.add('hidden');
        //     document.getElementById('skipTimer').textContent = 'Please wait 3 seconds...';
        //     document.getElementById('skipCountdown').textContent = '3';
        // }

        function getPuzzleIdFromUrl() { return new URLSearchParams(window.location.search).get('puzzle'); }
        function updateUrlWithPuzzle(puzzleId) {
            const url = new URL(window.location);
            url.searchParams.set('puzzle', puzzleId);
            window.history.pushState({}, '', url);
        }

        function sharePuzzle() {
            if (!currentPuzzle) return;
            const url = `${window.location.origin}${window.location.pathname}?puzzle=${currentPuzzle.id}`;
            if (navigator.share) {
                navigator.share({ title: 'Chess Puzzle Challenge', text: `Can you solve this ${currentPuzzle.rating} rated chess puzzle?`, url }).catch(() => copyToClipboard(url));
            } else copyToClipboard(url);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => showFeedback('üîó Link copied!', 'success'));
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showFeedback('üîó Link copied!', 'success');
            }
        }

        async function init() {
            setupEventListeners();
            const puzzleId = getPuzzleIdFromUrl();
            if (puzzleId) await loadSpecificPuzzle(puzzleId);
            else await loadNewPuzzle();
        }

        function setupEventListeners() {
            document.getElementById('newPuzzle').addEventListener('click', handleNextPuzzle);
            document.getElementById('hint').addEventListener('click', showHint);
            document.getElementById('reset').addEventListener('click', resetPuzzle);
            document.getElementById('share').addEventListener('click', sharePuzzle);
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('menuBtn').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarShare').addEventListener('click', () => { sharePuzzle(); toggleSidebar(); });
            document.getElementById('sidebarRemoveAds').addEventListener('click', () => window.location.href = 'payment.html?plan=ga-token');
            document.getElementById('skipAd').addEventListener('click', closeAdModal);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function handleNextPuzzle() {
            incrementPuzzleCount();

            if (shouldShowAd()) {
                showAdModal();
                setTimeout(() => { closeAdModal(); loadNewPuzzle(); }, time2nextPuzzle);
            } else loadNewPuzzle();


        }

        async function loadSpecificPuzzle(puzzleId) {
            try {
                const response = await fetch(BASE_URL+`/api/puzzle/${puzzleId}`);
                const puzzle = await response.json();
                if (puzzle.error) { showFeedback('Puzzle not found, loading random...', 'info'); await loadNewPuzzle(); return; }
                initializePuzzle(puzzle);
            } catch (error) { showFeedback('Error loading puzzle', 'error'); await loadNewPuzzle(); }
        }

        async function loadNewPuzzle() {
            try {
                const response = await fetch(BASE_URL+'/api/puzzle/random');
                const puzzle = await response.json();
                if (puzzle.error) { showFeedback('Error: ' + puzzle.error, 'error'); return; }
                updateUrlWithPuzzle(puzzle.id);
                initializePuzzle(puzzle);
            } catch (error) { showFeedback('Error loading puzzle', 'error'); }
        }

        function initializePuzzle(puzzle) {
            currentPuzzle = puzzle; currentMoveIndex = 0; playerMoveIndex = 0;
            selectedSquare = null; lastMoveSquares = [];
            game.parseFEN(puzzle.fen);
            const rating = puzzle.rating, themes = puzzle.themes || 'Various';
            const totalPlayerMoves = Math.ceil(puzzle.totalMoves / 2);
            document.getElementById('rating').textContent = rating;
            document.getElementById('themes').textContent = themes;
            document.getElementById('progress').textContent = `0/${totalPlayerMoves}`;
            document.getElementById('sidebarRating').textContent = rating;
            document.getElementById('sidebarThemes').textContent = themes;
            document.getElementById('sidebarProgress').textContent = `0/${totalPlayerMoves}`;
            updateProgressBar(0, puzzle.totalMoves);
            renderBoard(); hideFeedback(); startTimer();
            setTimeout(() => makeOpponentMove(), 800);
        }

        async function makeOpponentMove() {
            if (!currentPuzzle || currentMoveIndex >= currentPuzzle.moves.length) return;
            const move = currentPuzzle.moves[currentMoveIndex], from = move.substring(0, 2), to = move.substring(2);
            lastMoveSquares = [from, to]; game.makeMove(from, to); renderBoard(); currentMoveIndex++;
            playSound('moveSound');
            const playerTurn = game.isWhiteTurn ? 'White' : 'Black';
            document.getElementById('turnIndicator').textContent = `${playerTurn} to move - Find the best move! (Move ${playerMoveIndex + 1})`;
        }

        function renderBoard() {
            const board = document.getElementById('chessboard'); board.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = 'square ' + ((row + col) % 2 === 0 ? 'light' : 'dark');
                    square.dataset.row = row; square.dataset.col = col;
                    const algebraic = game.coordsToAlgebraic(row, col);
                    square.dataset.square = algebraic;
                    if (lastMoveSquares.includes(algebraic)) square.classList.add('last-move');
                    const piece = game.getPiece(row, col);
                    if (piece) {
                        const pieceElement = document.createElement('span');
                        pieceElement.className = 'piece ' + (game.isWhitePiece(piece) ? 'white' : 'black');
                        pieceElement.textContent = game.getPieceUnicode(piece);
                        square.appendChild(pieceElement);
                    }
                    square.addEventListener('click', handleSquareClick);
                    board.appendChild(square);
                }
            }
        }

        async function handleSquareClick(event) {
            const square = event.currentTarget, row = parseInt(square.dataset.row);
            const col = parseInt(square.dataset.col), algebraic = square.dataset.square;
            if (selectedSquare) {
                const from = selectedSquare, to = algebraic;
                if (from !== to) await attemptMove(from, to);
                document.querySelectorAll('.square').forEach(s => s.classList.remove('selected', 'highlight'));
                selectedSquare = null;
            } else {
                const piece = game.getPiece(row, col);
                if (piece && game.isWhitePiece(piece) === game.isWhiteTurn) {
                    selectedSquare = algebraic; square.classList.add('selected');
                    playSound('moveSound');
                    const moves = game.getPossibleMoves(row, col);
                    moves.forEach(move => {
                        const targetSquare = document.querySelector(`[data-square="${game.coordsToAlgebraic(move.row, move.col)}"]`);
                        if (targetSquare) targetSquare.classList.add('highlight');
                    });
                }
            }
        }

        /* async function attemptMove(from, to) {
            const move = from + to;
            try {
                const response = await fetch(BASE_URL+'/api/puzzle/verify', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ puzzleId: currentPuzzle.id, moveIndex: currentMoveIndex, move })
                });
                const result = await response.json();
                const toSquare = document.querySelector(`[data-square="${to}"]`);
                if (result.correct) {
                    toSquare.classList.add('correct-move');
                    setTimeout(() => toSquare.classList.remove('correct-move'), 600);
                    playSound('successSound');
                    lastMoveSquares = [from, to]; game.makeMove(from, to); renderBoard();
                    currentMoveIndex++; playerMoveIndex++;
                    const totalPlayerMoves = Math.ceil(currentPuzzle.totalMoves / 2);
                    showFeedback(`‚úì Move ${playerMoveIndex}/${totalPlayerMoves} correct! Great!`, 'success');
                    updateProgressBar(currentMoveIndex, currentPuzzle.totalMoves);
                    document.getElementById('progress').textContent = `${playerMoveIndex}/${totalPlayerMoves}`;
                    document.getElementById('sidebarProgress').textContent = `${playerMoveIndex}/${totalPlayerMoves}`;
                    if (result.complete) {
                        stopTimer(); incrementPuzzleCount();
                        setTimeout(() => showModal('üéâ Puzzle Solved!', `Congratulations! You solved it in ${playerMoveIndex} moves!`), 1000);
                    } else if (result.nextMove) {
                        setTimeout(async () => { await makeOpponentMove(); hideFeedback(); }, 1200);
                    }
                } else {
                    toSquare.classList.add('wrong-move');
                    setTimeout(() => toSquare.classList.remove('wrong-move'), 500);
                    showFeedback('‚úó Wrong move! Try again.', 'error');
                    setTimeout(hideFeedback, 2000);
                }
            } catch (error) { showFeedback('Error verifying move', 'error'); }
        }
 */
        
        
        async function attemptMove(from, to) {
            const move = from + to;
            const toSquare = document.querySelector(`[data-square="${to}"]`);

            try {
                const expectedMove = currentPuzzle.moves[currentMoveIndex];
                const isCorrect = move === expectedMove;
                const isComplete = currentMoveIndex >= currentPuzzle.moves.length - 1;

                if (isCorrect) {
                    toSquare.classList.add('correct-move');
                    setTimeout(() => toSquare.classList.remove('correct-move'), 600);

                    playSound('successSound');

                    lastMoveSquares = [from, to];
                    game.makeMove(from, to);
                    renderBoard();

                    currentMoveIndex++;
                    playerMoveIndex++;

                    const totalPlayerMoves = Math.ceil(currentPuzzle.totalMoves / 2);

                    showFeedback(
                        `‚úì Move ${playerMoveIndex}/${totalPlayerMoves} correct! Great!`,
                        'success'
                    );

                    updateProgressBar(currentMoveIndex, currentPuzzle.totalMoves);
                    document.getElementById('progress').textContent =
                        `${playerMoveIndex}/${totalPlayerMoves}`;
                    document.getElementById('sidebarProgress').textContent =
                        `${playerMoveIndex}/${totalPlayerMoves}`;

                    if (isComplete) {
                        stopTimer();
                        incrementPuzzleCount();

                        setTimeout(() => {
                            showModal(
                                'üéâ Puzzle Solved!',
                                `Congratulations! You solved it in ${playerMoveIndex} moves!`
                            );

                            // Load Adsterra ad under the modal
                            loadPuzzleSolvedAd_adsterra();

                        }, 1000);
                    } else {
                        // opponent move exists
                        setTimeout(async () => {
                            await makeOpponentMove();
                            hideFeedback();
                        }, 1200);
                    }

                } else {
                    toSquare.classList.add('wrong-move');
                    setTimeout(() => toSquare.classList.remove('wrong-move'), 500);

                    showFeedback('‚úó Wrong move! Try again.', 'error');
                    setTimeout(hideFeedback, 2000);
                }

            } catch (error) {
                console.error(error);
                showFeedback('Error verifying move', 'error');
            }
        }

 
        
 
        function updateProgressBar(current, total) {
            document.getElementById('progressBar').style.width = ((current / total) * 100) + '%';
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message; feedback.className = `feedback ${type}`;
            feedback.classList.remove('hidden');
        }
        function hideFeedback() { document.getElementById('feedback').classList.add('hidden'); }
        
        function showModal(title, message, isTimeout = false) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const actionsDiv = document.getElementById('modalActions');
            if (isTimeout && currentPuzzle) {
                actionsDiv.innerHTML = `
                    <button id="modalClose" class="btn btn-secondary">Continue</button>
                    <button id="getAnswer" class="btn btn-primary">Get Answer</button>
                `;
                document.getElementById('getAnswer').addEventListener('click', () => {
                    window.location.href = `payment.html?puzzle=${currentPuzzle.id}`;
                });
            } else {
                actionsDiv.innerHTML = '<button id="modalClose" class="btn btn-primary">Continue</button>';
            }
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            if (shouldShowAd()) { showAdModal(); setTimeout(() => { closeAdModal(); loadNewPuzzle(); }, time2nextPuzzle); }
            else loadNewPuzzle();
        }

        function startTimer() {
            stopTimer(); timeLeft = 120; updateTimerDisplay();
            timer = setInterval(() => {
                timeLeft--; updateTimerDisplay();
                if (timeLeft <= 0) { stopTimer(); showModal('‚è∞ Time\'s Up!', 'Time ran out! Upgrade to get instant answers.', true); }
            }, 1000);
        }
        function stopTimer() { if (timer) { clearInterval(timer); timer = null; } }
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60), seconds = timeLeft % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        function showHint() {
            if (currentPuzzle && currentMoveIndex < currentPuzzle.moves.length) {
                const nextMove = currentPuzzle.moves[currentMoveIndex], from = nextMove.substring(0, 2);
                showFeedback(`üí° Hint: Look at ${from.toUpperCase()}`, 'info');
                setTimeout(hideFeedback, 3000);
            }
        }
        function resetPuzzle() {
            if (currentPuzzle) {
                currentMoveIndex = 0; playerMoveIndex = 0; selectedSquare = null; lastMoveSquares = [];
                game.parseFEN(currentPuzzle.fen); renderBoard(); hideFeedback(); startTimer();
                const totalPlayerMoves = Math.ceil(currentPuzzle.totalMoves / 2);
                updateProgressBar(0, currentPuzzle.totalMoves);
                document.getElementById('progress').textContent = `0/${totalPlayerMoves}`;
                document.getElementById('sidebarProgress').textContent = `0/${totalPlayerMoves}`;
                setTimeout(() => makeOpponentMove(), 800);
            }
        }
        init();
    </script>
</body>
</html>